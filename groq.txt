from flask import Flask, request, jsonify  
from groq import Groq  
import requests  
import os  
  
app = Flask(__name__)  
  
GROQ_API_KEY = os.getenv("GROQ_API_KEY")  
SEATALK_BOT_TOKEN = os.getenv("SEATALK_BOT_TOKEN")  
  
groq_client = Groq(api_key=GROQ_API_KEY)  
  
def reply_to_seatalk(conversation_id, text):  
    url = "https://open.seatalk.io/api/v1/bot/send_message"  
    headers = {"Authorization": f"Bearer {SEATALK_BOT_TOKEN}"}  
    payload = {  
        "conversation_id": conversation_id,  
        "msg_type": "text",  
        "text": text  
    }  
    requests.post(url, json=payload, headers=headers)  
  
@app.post("/webhook")  
def webhook():  
    data = request.json  
    user_text = data["text"]  
    conv_id = data["conversation_id"]  
  
    # Call Groq LLM  
    response = groq_client.chat.completions.create(  
        model="llama3-70b-8192",  
        messages=[  
            {"role": "system", "content": "Reply concisely and helpfully."},  
            {"role": "user", "content": user_text}  
        ]  
    )  
  
    ai_reply = response.choices[0].message["content"]  
  
    # Send reply back to SeaTalk  
    reply_to_seatalk(conv_id, ai_reply)  
  
    return jsonify({"status": "ok"})  
  
app.run(port=5000)